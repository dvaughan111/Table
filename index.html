<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Form Widget</title>
    <style>
        /* [Your existing CSS styles remain exactly the same] */
        /* ... Your original CSS code ... */
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="order-table-container">
            <div class="table-header">
                <h3>ðŸ“‹ Order Form</h3>
            </div>
            
            <div class="table-wrapper">
                <table id="orderTable" class="order-table">
                    <thead>
                        <tr>
                            <th>QTY</th>
                            <th>DESCRIPTION</th>
                            <th>REASON</th>
                            <th>PRODUCT LINK</th>
                            <th>ORG</th>
                            <th>COST/ITEM</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows will be generated here -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="6">
                                <div class="footer-content">
                                    <div class="total-label">
                                        <span class="total-icon">ðŸŽ¯</span> GRAND TOTAL:
                                    </div>
                                    <button type="button" id="addRowBtn" class="add-row-btn">+ Add Row</button>
                                </div>
                            </td>
                            <td id="grandTotal" class="grand-total">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- CRITICAL: Hidden field that JotForm will capture -->
    <input type="hidden" id="orderFormData" name="orderFormData" value="">

    <script>
        // ============================================
        // JOTFORM WIDGET INTEGRATION
        // ============================================
        
        // Function to send data to JotForm parent
        function sendToJotForm(data) {
            try {
                // Method 1: Use JotForm Widget API if available
                if (typeof JFCustomWidget !== 'undefined') {
                    JFCustomWidget.sendData(data);
                }
                
                // Method 2: Direct parent communication for form submission
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({
                        type: 'JOTFORM_WIDGET_DATA',
                        widgetId: 'orderFormWidget',
                        data: data
                    }, '*');
                }
                
                // Method 3: Store in hidden field for form submission
                const hiddenField = document.getElementById('orderFormData');
                if (hiddenField) {
                    hiddenField.value = JSON.stringify(data);
                }
                
            } catch (e) {
                console.error('Error sending to JotForm:', e);
            }
        }

        // Initialize when JotForm is ready or on DOM load
        if (typeof JFCustomWidget !== 'undefined') {
            JFCustomWidget.subscribe('ready', initWidget);
            JFCustomWidget.subscribe('submit', onFormSubmit);
        } else {
            document.addEventListener('DOMContentLoaded', initWidget);
        }

        // ============================================
        // WIDGET FUNCTIONALITY
        // ============================================

        let widgetInitialized = false;
        let tableData = [];

        function initWidget() {
            if (widgetInitialized) return;
            widgetInitialized = true;
            
            initializeTable();
            document.getElementById('addRowBtn').addEventListener('click', addRow);
            
            // Auto-resize textareas
            setTimeout(() => {
                document.querySelectorAll('textarea').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        function initializeTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            // Clear existing data
            tableData = [];
            
            // Create 5 initial rows
            for (let i = 0; i < 5; i++) {
                addRow();
            }
            
            updateGrandTotal();
            saveAndSyncData();
        }

        function addRow(rowData = {}) {
            const tableBody = document.getElementById('tableBody');
            const rowId = rowData.id || 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const row = document.createElement('tr');
            row.id = `row-${rowId}`;
            row.innerHTML = `
                <td>
                    <input type="number" 
                           min="1" 
                           value="${rowData.quantity || 1}" 
                           class="quantity-input"
                           data-row="${rowId}">
                </td>
                <td>
                    <textarea class="description-input" 
                              placeholder="Item description" 
                              data-row="${rowId}"
                              rows="2">${rowData.description || ''}</textarea>
                </td>
                <td>
                    <textarea class="reason-input" 
                              placeholder="Reason for request" 
                              data-row="${rowId}"
                              rows="2">${rowData.reason || ''}</textarea>
                </td>
                <td>
                    <input type="url" 
                           class="link-input" 
                           placeholder="https://example.com"
                           value="${rowData.link || ''}"
                           data-row="${rowId}">
                </td>
                <td>
                    <select class="organization-select" data-row="${rowId}">
                        <option value="spark_home_health" ${(rowData.organization === 'spark_home_health') ? 'selected' : ''}>Spark HH</option>
                        <option value="spark_therapy" ${(rowData.organization === 'spark_therapy') ? 'selected' : ''}>Spark Therapy</option>
                        <option value="both" ${(rowData.organization === 'both') ? 'selected' : ''}>Both</option>
                    </select>
                </td>
                <td>
                    <div class="cost-input-wrapper">
                        <input type="number" 
                               step="0.01" 
                               min="0" 
                               value="${rowData.cost || '0.00'}" 
                               class="cost-input"
                               data-row="${rowId}">
                    </div>
                </td>
                <td>
                    <div class="total-cell-container">
                        <div class="row-total" id="row-total-${rowId}">${formatCurrency((rowData.quantity || 1) * (parseFloat(rowData.cost) || 0))}</div>
                        <div class="status-checkboxes">
                            <div class="checkbox-group">
                                <input type="checkbox" 
                                       id="approve-${rowId}" 
                                       class="status-approve"
                                       data-row="${rowId}"
                                       ${rowData.status === 'approve' ? 'checked' : ''}
                                       onchange="updateStatus('${rowId}', 'approve', this.checked)">
                                <label for="approve-${rowId}">Approve</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" 
                                       id="pend-${rowId}" 
                                       class="status-pend"
                                       data-row="${rowId}"
                                       ${rowData.status === 'pend' ? 'checked' : ''}
                                       onchange="updateStatus('${rowId}', 'pend', this.checked)">
                                <label for="pend-${rowId}">Pend</label>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Initialize textarea auto-resize
            const textareas = row.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                    saveAndSyncData();
                });
                setTimeout(() => autoResizeTextarea(textarea), 10);
            });
            
            // Add event listeners for data changes
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type !== 'checkbox') {
                    input.addEventListener('input', saveAndSyncData);
                    input.addEventListener('change', saveAndSyncData);
                }
            });
            
            // Add calculation listeners
            const quantityInput = row.querySelector('.quantity-input');
            const costInput = row.querySelector('.cost-input');
            
            const updateHandler = () => {
                updateRowTotal(rowId);
                updateGrandTotal();
                saveAndSyncData();
            };
            
            if (quantityInput) quantityInput.addEventListener('input', updateHandler);
            if (costInput) costInput.addEventListener('input', updateHandler);
            
            // Initial calculations
            updateRowTotal(rowId);
            updateGrandTotal();
            saveAndSyncData();
        }

        function updateRowTotal(rowId) {
            const quantityInput = document.querySelector(`.quantity-input[data-row="${rowId}"]`);
            const costInput = document.querySelector(`.cost-input[data-row="${rowId}"]`);
            const rowTotalElement = document.getElementById(`row-total-${rowId}`);
            
            if (!quantityInput || !costInput || !rowTotalElement) return;
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const costPerItem = parseFloat(costInput.value) || 0;
            const rowTotal = quantity * costPerItem;
            
            rowTotalElement.textContent = formatCurrency(rowTotal);
        }

        function updateGrandTotal() {
            const rowTotalElements = document.querySelectorAll('.row-total');
            let grandTotal = 0;
            
            rowTotalElements.forEach(element => {
                const text = element.textContent.replace(/[^0-9.-]+/g, "");
                const value = parseFloat(text) || 0;
                grandTotal += value;
            });
            
            const grandTotalElement = document.getElementById('grandTotal');
            if (grandTotalElement) {
                grandTotalElement.textContent = formatCurrency(grandTotal);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // ============================================
        // DATA PERSISTENCE FOR PDF GENERATION
        // ============================================

        function saveAndSyncData() {
            // Collect all row data
            const rows = document.querySelectorAll('#tableBody tr');
            tableData = [];
            
            rows.forEach(row => {
                const rowId = row.id.replace('row-', '');
                const quantity = row.querySelector('.quantity-input')?.value || '1';
                const description = row.querySelector('.description-input')?.value || '';
                const reason = row.querySelector('.reason-input')?.value || '';
                const link = row.querySelector('.link-input')?.value || '';
                const organization = row.querySelector('.organization-select')?.value || 'spark_home_health';
                const cost = row.querySelector('.cost-input')?.value || '0.00';
                const rowTotal = document.getElementById(`row-total-${rowId}`)?.textContent || '$0.00';
                const approveChecked = row.querySelector('.status-approve')?.checked || false;
                const pendChecked = row.querySelector('.status-pend')?.checked || false;
                const status = approveChecked ? 'approve' : (pendChecked ? 'pend' : '');
                
                tableData.push({
                    id: rowId,
                    quantity: quantity,
                    description: description,
                    reason: reason,
                    link: link,
                    organization: organization,
                    cost: cost,
                    rowTotal: rowTotal,
                    status: status
                });
            });
            
            const grandTotal = document.getElementById('grandTotal')?.textContent || '$0.00';
            
            // Prepare data for JotForm
            const formData = {
                tableData: tableData,
                grandTotal: grandTotal,
                // Create a text summary for PDF display
                summaryText: generateSummaryText(tableData, grandTotal),
                // Create HTML for PDF
                pdfHTML: generatePDFHTML(tableData, grandTotal)
            };
            
            // Send to JotForm
            sendToJotForm(formData);
            
            // Also store in hidden field
            const hiddenField = document.getElementById('orderFormData');
            if (hiddenField) {
                hiddenField.value = JSON.stringify(formData);
            }
        }

        function generateSummaryText(data, grandTotal) {
            let summary = `Order Form Summary (${data.length} items):\n`;
            data.forEach((item, index) => {
                summary += `${index + 1}. Qty: ${item.quantity}, Desc: ${item.description.substring(0, 30)}..., Cost: $${parseFloat(item.cost).toFixed(2)}, Total: ${item.rowTotal}\n`;
            });
            summary += `Grand Total: ${grandTotal}`;
            return summary;
        }

        function generatePDFHTML(data, grandTotal) {
            // Simple HTML that will render in PDF
            let html = `
            <div style="font-family: Arial, sans-serif; border: 1px solid #601a9b; border-radius: 5px; margin: 10px 0;">
                <div style="background: #601a9b; color: white; padding: 10px; font-weight: bold;">
                    Order Form Summary
                </div>
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr style="background: #f0e6f6;">
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Qty</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Description</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Reason</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Organization</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Cost</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Total</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.forEach(item => {
                const orgText = item.organization === 'spark_home_health' ? 'Spark HH' : 
                              item.organization === 'spark_therapy' ? 'Spark Therapy' : 'Both';
                const quantity = parseFloat(item.quantity) || 0;
                const cost = parseFloat(item.cost) || 0;
                const total = quantity * cost;
                
                html += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${quantity}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(item.description || '')}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(item.reason || '')}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${orgText}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${cost.toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${total.toFixed(2)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.status || ''}</td>
                    </tr>`;
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #601a9b; color: white; font-weight: bold;">
                            <td colspan="5" style="padding: 10px; border: 1px solid #601a9b; text-align: right;">Grand Total:</td>
                            <td colspan="2" style="padding: 10px; border: 1px solid #601a9b; text-align: right;">${grandTotal}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>`;
            
            return html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ============================================
        // GLOBAL FUNCTIONS
        // ============================================

        window.autoResizeTextarea = function(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        window.updateStatus = function(rowId, statusType, isChecked) {
            if (isChecked) {
                const otherCheckbox = document.querySelector(
                    statusType === 'approve' 
                    ? `.status-pend[data-row="${rowId}"]` 
                    : `.status-approve[data-row="${rowId}"]`
                );
                if (otherCheckbox) {
                    otherCheckbox.checked = false;
                }
            }
            saveAndSyncData();
        };

        // Form submission handler
        function onFormSubmit() {
            saveAndSyncData();
            return true;
        }

        // Listen for form submissions
        document.addEventListener('submit', function() {
            saveAndSyncData();
        });

        // Auto-save periodically
        setInterval(saveAndSyncData, 30000); // Every 30 seconds
    </script>
</body>
</html>
