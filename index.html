<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jotform Order Widget</title>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        /* This is only for the LIVE FORM view */
        body { font-family: sans-serif; margin: 0; padding: 10px; background: transparent; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th { background: #601a9b; color: white; padding: 10px; text-align: left; }
        td { border-bottom: 1px solid #eee; padding: 8px; }
        input, textarea, select { width: 100%; border: 1px solid #ccc; padding: 5px; border-radius: 4px; }
        .total-row { background: #4a148c; color: white; font-weight: bold; }
        .add-btn { background: #fc731c; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="main-content">
        <table id="orderTable">
            <thead>
                <tr>
                    <th style="width:50px">QTY</th>
                    <th>DESCRIPTION</th>
                    <th>ORG</th>
                    <th style="width:80px">COST</th>
                    <th style="width:100px">TOTAL</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="4" style="text-align:right; padding:10px;">GRAND TOTAL:</td>
                    <td id="grandTotal" style="padding:10px;">$0.00</td>
                </tr>
            </tfoot>
        </table>
        <button type="button" class="add-btn" id="addRowBtn">+ Add Item</button>
    </div>

    <script>
        // 1. DATA TO JOTFORM (Simplified & Inlined for PDF)
        function syncToJotform() {
            const rows = document.querySelectorAll('#tableBody tr');
            let total = 0;
            
            // Build a clean HTML string for the PDF with INLINE STYLES
            let htmlForPDF = `<table style="width:100%; border-collapse:collapse; font-family:sans-serif; border:1px solid #601a9b;">`;
            htmlForPDF += `<tr style="background:#601a9b; color:white;"><th>QTY</th><th>DESCRIPTION</th><th>ORG</th><th>TOTAL</th></tr>`;
            
            rows.forEach(row => {
                const q = row.querySelector('.qty').value || 0;
                const d = row.querySelector('.desc').value || "";
                const o = row.querySelector('.org').value;
                const c = row.querySelector('.cost').value || 0;
                const rowTotal = (q * c).toFixed(2);
                total += parseFloat(rowTotal);
                
                htmlForPDF += `<tr>
                    <td style="border:1px solid #eee; padding:8px; text-align:center;">${q}</td>
                    <td style="border:1px solid #eee; padding:8px;">${d}</td>
                    <td style="border:1px solid #eee; padding:8px;">${o}</td>
                    <td style="border:1px solid #eee; padding:8px;">$${rowTotal}</td>
                </tr>`;
            });
            
            htmlForPDF += `<tr style="background:#f3f3f3; font-weight:bold;"><td colspan="3" style="text-align:right; padding:10px;">GRAND TOTAL:</td><td style="padding:10px;">$${total.toFixed(2)}</td></tr>`;
            htmlForPDF += `</table>`;

            // Update visible total in widget
            document.getElementById('grandTotal').textContent = `$${total.toFixed(2)}`;

            // Send to Jotform
            JOTFORM.sendData({ value: htmlForPDF });
        }

        // 2. WIDGET LOGIC
        function addRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="number" class="qty" value="1"></td>
                <td><textarea class="desc" rows="1"></textarea></td>
                <td><select class="org"><option>Spark HH</option><option>Spark Therapy</option></select></td>
                <td><input type="number" class="cost" value="0.00" step="0.01"></td>
                <td class="row-total">$0.00</td>
            `;
            document.getElementById('tableBody').appendChild(tr);
            
            // Add listeners to every new input
            tr.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', () => {
                    const q = tr.querySelector('.qty').value;
                    const c = tr.querySelector('.cost').value;
                    tr.querySelector('.row-total').textContent = '$' + (q * c).toFixed(2);
                    syncToJotform();
                });
            });
        }

        // Initialize
        document.getElementById('addRowBtn').addEventListener('click', addRow);
        addRow(); // Start with one row
        
        JOTFORM.subscribe("ready", function() {
            syncToJotform();
        });
    </script>
</body>
</html>
