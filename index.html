<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Form</title>
    <style>
        /* [Keep all your existing CSS styles here - they remain the same] */
        /* ... Your existing CSS ... */
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="order-table-container">
            <div class="table-header">
                <h3>ðŸ“‹ Order Form</h3>
            </div>
            
            <div class="table-wrapper">
                <table id="orderTable" class="order-table">
                    <thead>
                        <tr>
                            <th>QTY</th>
                            <th>DESCRIPTION</th>
                            <th>REASON</th>
                            <th>PRODUCT LINK</th>
                            <th>ORG</th>
                            <th>COST/ITEM</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows will be generated here -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="6">
                                <div class="footer-content">
                                    <div class="total-label">
                                        <span class="total-icon">ðŸŽ¯</span> GRAND TOTAL:
                                    </div>
                                    <button type="button" id="addRowBtn" class="add-row-btn">+ Add Row</button>
                                </div>
                            </td>
                            <td id="grandTotal" class="grand-total">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- HIDDEN FIELD TO STORE TABLE DATA FOR PDF GENERATION -->
    <div style="display: none;">
        <textarea id="tableDataStorage" name="tableDataStorage"></textarea>
    </div>

    <script>
        // JOTFORM WIDGET INITIALIZATION
        if (typeof JFCustomWidget !== 'undefined') {
            // Widget is loaded in form builder or form view
            JFCustomWidget.subscribe('ready', function() {
                initializeWidget();
            });
        } else {
            // Fallback for direct HTML preview
            document.addEventListener('DOMContentLoaded', function() {
                initializeWidget();
            });
        }

        function initializeWidget() {
            initializeTable();
            document.getElementById('addRowBtn').addEventListener('click', addRow);
            
            // Initialize auto-resize for textareas
            setTimeout(() => {
                document.querySelectorAll('textarea').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        function initializeTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            // Try to load existing data from JotForm
            let existingData = [];
            try {
                // Check if we're in JotForm context
                if (window.parent && window.parent.JFCustomWidget) {
                    const widgetData = window.parent.JFCustomWidget.getWidgetData();
                    if (widgetData && widgetData.tableData) {
                        existingData = JSON.parse(widgetData.tableData);
                    }
                }
            } catch (e) {
                console.log('No existing data found');
            }
            
            if (existingData.length > 0) {
                // Load existing rows
                existingData.forEach(rowData => {
                    addRow(rowData);
                });
            } else {
                // Create 5 initial rows
                for (let i = 0; i < 5; i++) {
                    addRow();
                }
            }
            
            updateGrandTotal();
            saveTableData(); // Save initial data
        }

        function addRow(rowData = {}) {
            const tableBody = document.getElementById('tableBody');
            const rowId = rowData.id || Date.now() + Math.random();
            
            const row = document.createElement('tr');
            row.id = `row-${rowId}`;
            row.innerHTML = `
                <td>
                    <input type="number" 
                           min="1" 
                           value="${rowData.quantity || 1}" 
                           class="quantity-input"
                           data-row="${rowId}">
                </td>
                <td>
                    <textarea class="description-input" 
                              placeholder="Item description" 
                              data-row="${rowId}"
                              rows="2">${rowData.description || ''}</textarea>
                </td>
                <td>
                    <textarea class="reason-input" 
                              placeholder="Reason for request" 
                              data-row="${rowId}"
                              rows="2">${rowData.reason || ''}</textarea>
                </td>
                <td>
                    <input type="url" 
                           class="link-input" 
                           placeholder="https://example.com"
                           value="${rowData.link || ''}"
                           data-row="${rowId}">
                </td>
                <td>
                    <select class="organization-select" data-row="${rowId}">
                        <option value="spark_home_health" ${(rowData.organization === 'spark_home_health') ? 'selected' : ''}>Spark HH</option>
                        <option value="spark_therapy" ${(rowData.organization === 'spark_therapy') ? 'selected' : ''}>Spark Therapy</option>
                        <option value="both" ${(rowData.organization === 'both') ? 'selected' : ''}>Both</option>
                    </select>
                </td>
                <td>
                    <div class="cost-input-wrapper">
                        <input type="number" 
                               step="0.01" 
                               min="0" 
                               value="${rowData.cost || '0.00'}" 
                               class="cost-input"
                               data-row="${rowId}">
                    </div>
                </td>
                <td>
                    <div class="total-cell-container">
                        <div class="row-total" id="row-total-${rowId}">${formatCurrency((rowData.quantity || 1) * (parseFloat(rowData.cost) || 0))}</div>
                        <div class="status-checkboxes">
                            <div class="checkbox-group">
                                <input type="checkbox" 
                                       id="approve-${rowId}" 
                                       class="status-approve"
                                       data-row="${rowId}"
                                       ${rowData.status === 'approve' ? 'checked' : ''}
                                       onchange="updateStatus('${rowId}', 'approve', this.checked)">
                                <label for="approve-${rowId}">Approve</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" 
                                       id="pend-${rowId}" 
                                       class="status-pend"
                                       data-row="${rowId}"
                                       ${rowData.status === 'pend' ? 'checked' : ''}
                                       onchange="updateStatus('${rowId}', 'pend', this.checked)">
                                <label for="pend-${rowId}">Pend</label>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Auto-resize textareas
            const textareas = row.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
                // Set initial height
                setTimeout(() => autoResizeTextarea(textarea), 10);
            });
            
            // Add calculation listeners
            const quantityInput = row.querySelector('.quantity-input');
            const costInput = row.querySelector('.cost-input');
            const descriptionInput = row.querySelector('.description-input');
            const reasonInput = row.querySelector('.reason-input');
            const linkInput = row.querySelector('.link-input');
            const orgSelect = row.querySelector('.organization-select');
            
            const updateHandler = () => {
                updateRowTotal(rowId);
                updateGrandTotal();
                saveTableData();
            };
            
            quantityInput.addEventListener('input', updateHandler);
            quantityInput.addEventListener('change', updateHandler);
            costInput.addEventListener('input', updateHandler);
            costInput.addEventListener('change', updateHandler);
            descriptionInput.addEventListener('input', saveTableData);
            reasonInput.addEventListener('input', saveTableData);
            linkInput.addEventListener('input', saveTableData);
            orgSelect.addEventListener('change', saveTableData);
            
            // Initial calculation
            updateRowTotal(rowId);
            updateGrandTotal();
            saveTableData();
        }

        function updateRowTotal(rowId) {
            const quantityInput = document.querySelector(`.quantity-input[data-row="${rowId}"]`);
            const costInput = document.querySelector(`.cost-input[data-row="${rowId}"]`);
            const rowTotalElement = document.getElementById(`row-total-${rowId}`);
            
            if (!quantityInput || !costInput || !rowTotalElement) return;
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const costPerItem = parseFloat(costInput.value) || 0;
            const rowTotal = quantity * costPerItem;
            
            rowTotalElement.textContent = formatCurrency(rowTotal);
        }

        function updateGrandTotal() {
            const rowTotalElements = document.querySelectorAll('.row-total');
            let grandTotal = 0;
            
            rowTotalElements.forEach(element => {
                const text = element.textContent.replace(/[^0-9.-]+/g, "");
                const value = parseFloat(text) || 0;
                grandTotal += value;
            });
            
            const grandTotalElement = document.getElementById('grandTotal');
            if (grandTotalElement) {
                grandTotalElement.textContent = formatCurrency(grandTotal);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // CRITICAL FUNCTION: Save table data for PDF generation
        function saveTableData() {
            const rows = document.querySelectorAll('#tableBody tr');
            const tableData = [];
            
            rows.forEach(row => {
                const rowId = row.id.replace('row-', '');
                const quantity = row.querySelector('.quantity-input')?.value || '1';
                const description = row.querySelector('.description-input')?.value || '';
                const reason = row.querySelector('.reason-input')?.value || '';
                const link = row.querySelector('.link-input')?.value || '';
                const organization = row.querySelector('.organization-select')?.value || 'spark_home_health';
                const cost = row.querySelector('.cost-input')?.value || '0.00';
                const rowTotal = document.getElementById(`row-total-${rowId}`)?.textContent || '$0.00';
                const approveChecked = row.querySelector('.status-approve')?.checked || false;
                const pendChecked = row.querySelector('.status-pend')?.checked || false;
                const status = approveChecked ? 'approve' : (pendChecked ? 'pend' : '');
                
                tableData.push({
                    id: rowId,
                    quantity: quantity,
                    description: description,
                    reason: reason,
                    link: link,
                    organization: organization,
                    cost: cost,
                    rowTotal: rowTotal,
                    status: status
                });
            });
            
            // Store in hidden textarea for form submission
            const storageElement = document.getElementById('tableDataStorage');
            if (storageElement) {
                storageElement.value = JSON.stringify(tableData);
            }
            
            // Also store in JotForm widget data
            try {
                if (typeof JFCustomWidget !== 'undefined') {
                    JFCustomWidget.sendData({
                        tableData: JSON.stringify(tableData),
                        grandTotal: document.getElementById('grandTotal')?.textContent || '$0.00'
                    });
                }
            } catch (e) {
                console.log('JotForm widget API not available');
            }
            
            // Create HTML representation for PDF
            createPDFHTML(tableData);
        }

        // Create static HTML representation for PDF
        function createPDFHTML(tableData) {
            const pdfContainer = document.getElementById('pdfContainer');
            if (!pdfContainer) {
                const container = document.createElement('div');
                container.id = 'pdfContainer';
                container.style.display = 'none';
                container.innerHTML = generatePDFHTML(tableData);
                document.body.appendChild(container);
            } else {
                pdfContainer.innerHTML = generatePDFHTML(tableData);
            }
            
            // Also store in another hidden field for PDF
            const pdfDataElement = document.getElementById('pdfData');
            if (!pdfDataElement) {
                const pdfData = document.createElement('textarea');
                pdfData.id = 'pdfData';
                pdfData.name = 'pdfData';
                pdfData.style.display = 'none';
                pdfData.value = generatePDFHTML(tableData);
                document.body.appendChild(pdfData);
            } else {
                pdfDataElement.value = generatePDFHTML(tableData);
            }
        }

        function generatePDFHTML(tableData) {
            let html = `
                <div class="pdf-order-table" style="font-family: Arial, sans-serif; width: 100%;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                        <thead>
                            <tr style="background-color: #601a9b; color: white;">
                                <th style="padding: 6px; text-align: left; width: 45px;">QTY</th>
                                <th style="padding: 6px; text-align: left; width: 110px;">DESCRIPTION</th>
                                <th style="padding: 6px; text-align: left; width: 95px;">REASON</th>
                                <th style="padding: 6px; text-align: left; width: 125px;">PRODUCT LINK</th>
                                <th style="padding: 6px; text-align: left; width: 100px;">ORG</th>
                                <th style="padding: 6px; text-align: center; width: 75px;">COST/ITEM</th>
                                <th style="padding: 6px; text-align: left; width: 135px;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            let grandTotal = 0;
            
            tableData.forEach(row => {
                const quantity = parseFloat(row.quantity) || 0;
                const cost = parseFloat(row.cost) || 0;
                const rowTotal = quantity * cost;
                grandTotal += rowTotal;
                
                const orgDisplay = row.organization === 'spark_home_health' ? 'Spark HH' : 
                                  row.organization === 'spark_therapy' ? 'Spark Therapy' : 'Both';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 6px;">${quantity}</td>
                        <td style="padding: 6px;">${escapeHtml(row.description)}</td>
                        <td style="padding: 6px;">${escapeHtml(row.reason)}</td>
                        <td style="padding: 6px; word-break: break-all;">${escapeHtml(row.link)}</td>
                        <td style="padding: 6px;">${orgDisplay}</td>
                        <td style="padding: 6px; text-align: center;">$${cost.toFixed(2)}</td>
                        <td style="padding: 6px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span>$${rowTotal.toFixed(2)}</span>
                                ${row.status ? `<span style="font-size: 8px; color: #666;">(${row.status})</span>` : ''}
                            </div>
                        </td>
                    </tr>`;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #601a9b; color: white; font-weight: bold;">
                                <td colspan="6" style="padding: 10px;">
                                    GRAND TOTAL:
                                </td>
                                <td style="padding: 10px; text-align: right;">
                                    $${grandTotal.toFixed(2)}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>`;
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.autoResizeTextarea = function(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            saveTableData(); // Save when textarea resizes
        }

        window.updateStatus = function(rowId, statusType, isChecked) {
            if (isChecked) {
                const otherCheckbox = document.querySelector(
                    statusType === 'approve' 
                    ? `.status-pend[data-row="${rowId}"]` 
                    : `.status-approve[data-row="${rowId}"]`
                );
                if (otherCheckbox) {
                    otherCheckbox.checked = false;
                }
            }
            saveTableData();
        };
    </script>
</body>
</html>
