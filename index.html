<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Form Widget</title>
    
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>

    <style>
        /* CLEAN, COMPACT DESIGN */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: transparent !important; /* Required for Jotform */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .widget-container {
            padding: 10px 5px;
            max-width: 750px;
            margin: 0 auto;
        }
        
        .order-table-container {
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(96, 26, 155, 0.1);
            overflow: hidden;
            border: 1px solid #e0d4e9;
        }
        
        /* TABLE HEADER */
        .table-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #601a9b 0%, #4a148c 100%);
            color: white;
        }
        
        .table-header h3 {
            margin: 0;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
        }
        
        /* TABLE */
        .table-wrapper { overflow-x: auto; }
        
        .order-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 12px;
        }
        
        .order-table th {
            background-color: #f8f3fc;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            color: #601a9b;
            border-bottom: 2px solid #e0d4e9;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .order-table td {
            padding: 8px 4px;
            border-bottom: 1px solid #f0e6f6;
            vertical-align: top;
            color: #000000;
        }
        
        /* COLUMN WIDTHS */
        .order-table th:nth-child(1) { width: 45px; text-align: center; } /* Qty */
        .order-table th:nth-child(2) { width: 110px; } /* Desc */
        .order-table th:nth-child(3) { width: 95px; }  /* Reason */
        .order-table th:nth-child(4) { width: 125px; } /* Link */
        .order-table th:nth-child(5) { width: 100px; } /* Org */
        .order-table th:nth-child(6) { width: 75px; text-align: center; } /* Cost */
        .order-table th:nth-child(7) { width: 135px; } /* Total */
        
        /* INPUTS */
        .order-table input, .order-table textarea, .order-table select {
            width: 100%;
            padding: 6px 4px;
            border: 1px solid #d8c8e4;
            border-radius: 3px;
            font-size: 12px;
            background-color: #fefcff;
        }

        /* COST INPUT */
        .cost-input-wrapper { position: relative; width: 100%; }
        .cost-input-wrapper::before {
            content: "$";
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #601a9b;
            font-weight: 600;
            font-size: 11px;
        }
        .cost-input { padding-left: 16px !important; text-align: right; }

        /* FOOTER / TOTALS */
        .total-row {
            background: linear-gradient(to right, #601a9b, #4a148c);
            color: white;
            height: 60px;
        }
        
        .footer-content {
            padding-left: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .add-row-btn {
            background-color: #fc731c;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            width: fit-content;
        }

        .grand-total {
            font-size: 14px;
            font-weight: 700;
            text-align: right;
            padding-right: 15px;
        }

        /* PDF / PRINT OPTIMIZATION */
        @media print {
            .add-row-btn { display: none !important; }
            input, textarea, select {
                border: none !important;
                background: transparent !important;
                appearance: none;
                -webkit-appearance: none;
            }
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="order-table-container">
            <div class="table-header">
                <h3>ðŸ“‹ Order Form</h3>
            </div>
            <div class="table-wrapper">
                <table id="orderTable" class="order-table">
                    <thead>
                        <tr>
                            <th>QTY</th>
                            <th>DESCRIPTION</th>
                            <th>REASON</th>
                            <th>PRODUCT LINK</th>
                            <th>ORG</th>
                            <th>COST/ITEM</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="6">
                                <div class="footer-content">
                                    <div style="font-size: 13px; font-weight: 700;">ðŸŽ¯ GRAND TOTAL:</div>
                                    <button type="button" id="addRowBtn" class="add-row-btn">+ Add Row</button>
                                </div>
                            </td>
                            <td id="grandTotal" class="grand-total">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <script>
        function sendDataToJotform() {
    const tableElement = document.getElementById('orderTable');
    // We use a clone to ensure we aren't sending "live" UI buttons to the PDF
    const tableClone = tableElement.cloneNode(true);
    const btn = tableClone.querySelector('#addRowBtn');
    if(btn) btn.remove();

    // 1. Convert inputs to static text for the PDF
    tableClone.querySelectorAll('input, textarea, select').forEach(el => {
        const val = el.value || "";
        const span = document.createElement('span');
        span.textContent = (el.tagName === 'SELECT') ? el.options[el.selectedIndex].text : val;
        el.parentNode.replaceChild(span, el);
    });

    const finalHTML = tableClone.outerHTML;

    // 2. Send data to the widget itself
    JOTFORM.sendData({ value: finalHTML });

    // 3. THE MAGIC: Push to the hidden Jotform field (the "Proxy")
    // This allows the PDF Editor to see a "Standard Field" instead of a widget
    window.parent.postMessage({
        type: 'setValues',
        value: {
            'tableProxy': finalHTML // Replace 'tableProxy' with your field's Unique Name
        }
    }, '*');
}

            // Hide the "Add Row" button in the PDF data
            const btn = tableClone.querySelector('#addRowBtn');
            if(btn) btn.style.display = 'none';

            // Send the cleaned HTML string to Jotform
            JOTFORM.sendData({
                value: tableClone.outerHTML
            });
        }

        // --- TABLE LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeTable();
            document.getElementById('addRowBtn').addEventListener('click', addRow);
            
            // Start the Jotform Widget Subscription
            JOTFORM.subscribe("ready", function() {
                sendDataToJotform(); // Initial sync
            });
        });

        function initializeTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            for (let i = 0; i < 3; i++) { addRow(); }
            updateGrandTotal();
        }

        function addRow() {
            const tableBody = document.getElementById('tableBody');
            const rowId = Date.now() + Math.random();
            const row = document.createElement('tr');
            row.id = `row-${rowId}`;
            row.innerHTML = `
                <td><input type="number" min="1" value="1" class="quantity-input" data-row="${rowId}"></td>
                <td><textarea class="description-input" placeholder="Item description" data-row="${rowId}" rows="2"></textarea></td>
                <td><textarea class="reason-input" placeholder="Reason" data-row="${rowId}" rows="2"></textarea></td>
                <td><input type="url" class="link-input" placeholder="https://" data-row="${rowId}"></td>
                <td>
                    <select class="organization-select" data-row="${rowId}">
                        <option value="spark_home_health">Spark HH</option>
                        <option value="spark_therapy">Spark Therapy</option>
                        <option value="both">Both</option>
                    </select>
                </td>
                <td><div class="cost-input-wrapper"><input type="number" step="0.01" value="0.00" class="cost-input" data-row="${rowId}"></div></td>
                <td><div class="row-total" id="row-total-${rowId}">$0.00</div></td>
            `;
            tableBody.appendChild(row);

            // Add change listeners to trigger sync
            row.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('input', () => {
                    updateRowTotal(rowId);
                    updateGrandTotal();
                    sendDataToJotform(); // Push to Jotform on every keystroke
                });
            });
        }

        function updateRowTotal(rowId) {
            const qty = parseFloat(document.querySelector(`.quantity-input[data-row="${rowId}"]`).value) || 0;
            const cost = parseFloat(document.querySelector(`.cost-input[data-row="${rowId}"]`).value) || 0;
            document.getElementById(`row-total-${rowId}`).textContent = formatCurrency(qty * cost);
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll('.row-total').forEach(el => {
                total += parseFloat(el.textContent.replace(/[^0-9.-]+/g, "")) || 0;
            });
            document.getElementById('grandTotal').textContent = formatCurrency(total);
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        }
    </script>
</body>
</html>
